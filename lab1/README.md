# Dockerfile - плохой и хороший

## Предыстория
Приложение, которое будет здесь разворачиваться - небольшое приложение FastAPI для общения с API LLM.
Зависимости проекта оформлены через conda.

## Dockerfile с плохими практиками

### что с ним не так:
1. явно указана платформа, на что вылетает warning от докера
2. не указана четкая версия базового изображения - latest версия не дает никаких гарантий о сохранении версий, при которых все работает.
3. происходят установки сторонних зависимостей - раздувается образ.
4. захардкожены пути - костыль, чтобы оболочка просто увидела установленную конду внутри контейнера. И PYTHOPATH тоже захардкожен, потому что без него не едет.
5. используется CMD вместо ENTRYPOINT, хотя по сути последняя строчка является запуском сервера FastAPI - процесса, ради которого живет контейнер, и эта команда инварианта.

Итого:
- 5 warnings от докера после билда
- размер изображения - 4 Gb (так как неверно выбрано исходное изображение)
- запускается на костылях и с божьей помощью

### Билд
```sh
sudo docker build -f ./lab1/bad.Dockerfile -t aichem-chat-bad:latest .
```

### Запуск
```sh
sudo docker run --rm -p 8000:8000 --name aichem-chat-bad --env-file secrets.env -d aichem-chat-bad:latest
```

## Dockerfile с хорошими практиками

### что в нем поправлено:
1. нет строчки с указанием платформы в докерфайле
2. выбран образ micromamba с указанием конкретной версией - не нужно устанавливать доп зависимости, исходный образ сразу заточен под работу с conda
3. установки всех зависимостей проекта в соответствие с документацией micromamba, а не костылями
4. нигде не захардкожены пути
5. для запуска сервера FastAPI используется ENTRYPOINT и .sh скрипт, содержащий все необходимые команды

### Итого
- размер изображения 2 Gb - все еще не эталон, но в два раза меньше предыдущего.
- нет костылей, которые были бы нужны просто для того чтобы оно запустилось

### Билд
```sh
sudo docker build -f ./lab1/good.Dockerfile -t aichem-chat-good:latest --platform="linux/amd64" .
```

### Запуск
```sh
sudo docker run --rm \
    --platform="linux/amd64" \
    -p 8000:8000 \
    -v ./src:/app/src \
    --env-file sercrets.env \
    --name aichem-chat-good \
    -d \
    aichem-chat-good:latest
```

## Плохие практики использования контейнеризации
1. Не стоит использовать контейнеры, когда приложение является предметом критической инфраструктуры, 
и для него нужно обеспечивать высокий уровень безопасности.

2. Также контейнеризация нежелательна, если необходимо ускорить работу приложения. Дополнительная прослойка между 
процессом и хостовой ОС в виде докера способна создавать так называемые bottlenecks, которые могут значительно влиять на производительность.
